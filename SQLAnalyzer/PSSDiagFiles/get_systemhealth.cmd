@ECHO OFF
SETLOCAL
SET DUMPDIR=%1
SET INSTANCE=%2
SET INSTANCE=%INSTANCE:"=%
SET OUTPUTDIR=%3

SET /A DUMPFILETOTALBYTES=0
CALL :CopyDirRecursive system_health*.xel
CALL :CopyDirRecursive AlwaysOn_health*.xel

ENDLOCAL
GOTO :eof


:CopyDirRecursive
FOR /F "tokens=*" %%I IN ('dir /B /S /O:-d "%DUMPDIR:"=%%1" ') DO CALL :CheckFile "%%I"
GOTO :eof

:CheckFile 
FOR %%I IN (%1) DO SET FILESIZE=%%~zI
FOR %%I IN (%1) DO SET FILENAME="%%~nxI"
SET DESTFILENAME="%OUTPUTDIR:"=%%COMPUTERNAME%_%INSTANCE%_%FILENAME:"=%"
SET DESTFILENAME_SKIPPED="%DESTFILENAME:"=%.TXT"

SET /A DUMPFILETOTALBYTES=%DUMPFILETOTALBYTES% + %FILESIZE%
copy /y %1 %DESTFILENAME%
del /f /q %DESTFILENAME_SKIPPED% > NUL 2>&1

GOTO :eof
